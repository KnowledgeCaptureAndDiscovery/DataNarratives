<!-- Import scripts - webcomponents(js) and jquery and web componenents (.html) -->
<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/app-layout/app-layout.html">
<link rel="import" href="/bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="/bower_components/app-layout/demo/sample-content.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/polymer/lib/utils/gestures.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html"> 
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/resizable-panels/resizable-panels.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="/bower_components/polymer/elements/dom-repeat.html">

<!-- 
Define the web component feedback-app in <dom-module>
Definition consists of structure - defined in <template> tag, and scripts defined in <script> tag 
Style and custom style is also included in <template>
In Polymer, the web component defined by <dom-module> is associated with an ES6/JavaScript class
Using this web component (simply dropping it in an HTML document)creates an instance of the associated class in the browser
The web component defines a 'shadow DOM' i.e. its internal components (other HTML tags or web componenets)
are visible to the instance but not to the DOM tree
Each web component has properties which could be data or methods
Both one-way and two-way binding between the properties in the object and attributes or content of 
tags in the <template> are allowed. 
-->

<dom-module id="feedback-app">
  
    <template>
        <custom-style>
            <style is="custom-style">
              html, body {
                margin: 0;
                font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                background: #f1f1f1;
                max-height: 368px;
              }
              app-toolbar {
                background-color: #4285f4;
                color: #fff;
              }
          
              paper-icon-button {
                --paper-icon-button-ink-color: white;
              }
          
              /* app-header {
                @apply --layout-fixed-top;
                color: #fff;
                --app-header-background-rear-layer: {
                  background-color: #ef6c00;
                };
              } */
              
              #main-content{
                display: flex;
              }
              #narrative-views{
                border-width: 2px;
                border-style:solid;
                border-color: chocolate;
                margin-top: 0px;
                margin-right: 0px;
                display: list-item;
                padding: 20px;
              }
              #narrative-editor{
                border-style: dotted;
                border-width: 4px;
                border-color: coral;
                margin-top: 0px;
                margin-left: 0px;
                width: 500px;
                position: fixed;
              }
              sample-content {
                padding-top: 64px;
              }
              
              paper-card{
                color: black;
                width: 100%;
                word-wrap: break-word;
                margin-bottom: 10px
              }
              paper-tooltip{
                --paper-tooltip-delay-in: 500;
                font-size: 12pt;
              }
              .panel { 
                padding: 20px; 
                color: white; 
                width: 100%;
                height: 100%;
                /* max-width: 100%; */
              }
              .p1 { 
                background-color: white; 
                width: 100%;
                /* height: 100%; */
                /* max-width: 100%;  */
                /* overflow-y: scroll; */
              }
              .p2 { 
                background-color: beige; 
                width: 50%;
                /* height: 100%; */
                /* max-width: 50%  */
              }
              .card-body {
                margin:20px;
              }
              #link-to-edit {
                color: white;
              }
              paper-button.red {
                background-color: var(--paper-red-500);
                color: white;
              } 
              paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
              }
              .editor-toolbar {
                background-color: #41f4b5;

              }         
          </style>
        </custom-style>
    
        <!--
          The structure of the document is created by putting in tags - 
          HTML or web components (user-defined or from a library).
          <app-header-layout> positions an <app-header> and other content
        -->
        <app-header-layout>
          <app-header>
            <app-toolbar>
              DANA: DAta NArratives
            </app-toolbar>
          </app-header>
    
          <!--
            <resizable-panels> creates resizable panels (horizontally by default) - each of which is placed in a <div>
            -->  
          <resizable-panels>
            <!--
              The first panel is for placing the narrative views
            -->
            <div class="panel p1" id="view">
              <!--
                Each narrative is placed in a <paper-card>
                It contains a heading like <paper-toolbar>, 
                <paper-tooltip> for displaying tooltip text,
                followed by the actual body of the card.
                This body is encapsulated in an <iron-collapse> tag
                for collapsing or expanding the card. The body contains
                buttons in <paper-button> and a <div> for holding the narrative
                text
                The contents into <paper-toolbar>, <paper-tooltip> and the body
                are data-binded with respective subproperties of each element
                in the narratives property.
                The same template is stamped on to each element in narratives to
                create as many <paper-card> components as there are views. To this
                end, <dom-repeat> is used.
                -->

              <!--
                'items' here is the attribute to be set to an Array propoerty supplied by
                the class FeedbackApp.
              -->
              <dom-repeat items="{{narratives}}">
                  <template>
                      <paper-card>
                          <!--
                            Since the 'id' attribute cannot be assigned uniquely to each <paper-card>
                            in the <dom-repeat> syntax, another attribute called 'identity' is created and 
                            data-binded with the 'index' property automatically created by <dom-repeat>
                            as the index of the element of the 'items' array.
                          -->
                          <paper-toolbar on-click="toggleCollapse" identity$="{{index}}">
                              <!--
                                Similar to 'index', <dom-repeat> also provides another property - 'item'
                                as an alias or reference to the current element in the 'items' array to 
                                which the <dom-repeat> template is being applied.
                                In this case, each 'item' refers to a narrative view. Therefore its subproperties
                                title, tooltip_text and text are data-binded at the respective places.
                              --> 
                              <div slot="top" id="cardtooltip" class="title">{{item.title}}</div>
                          </paper-toolbar>
                          <paper-tooltip id="cardtooltip" for="cardtitle" position="top">{{item.tooltip_text}}</paper-tooltip>
                          <iron-collapse identity$="{{index}}">
                            <div class="card-body">
                                <div class="card-actions">
                                    <!--
                                    Clicking the 'Edit' button opens the narrative editor - the second <div> as panel
                                    Clicking the 'See More' button will show hidden parts of the test
                                    Clicking the 'See Less' button will hide hideable parts of the text
                                    The event handlers are defined in the <script> tag as instance methods of FeedbackApp
                                    -->
                                    <div class="horizontal justified">
                                        <paper-button on-click="openEditor" identity$="{{index}}">Edit</paper-button>
                                        <paper-button on-click="seeMore" identity$="{{index}}">See More</paper-button>
                                        <paper-button on-click="seeLess" identity$="{{index}}">See Less</paper-button>
                                    </div>
                                </div>
                                
                                <div class="card-content" identity$="{{index}}">{{item.text}}</div>
                            </div>
                          </iron-collapse>
                      </paper-card>
                  </template>
                </dom-repeat>
    
              <br/>
    
              </div>
              <!-- 
                The second panel is for dislaying the narrative editor
                The narrative editor is inserted with the text content of the 
                view which caused the opening of the editor
              -->
              <div class="panel p2" id="editor" hidden$="{{hideEditor}}" edit-state$="{{editState}}">
                  <paper-card>
                      <paper-toolbar class="editor-toolbar">
                          <div slot="top" class="title">Narrative Editor</div>
                      </paper-toolbar>
                      <div class="card-actions">
                          <div class="horizontal justified">
                              <paper-button on-click="editLinkMode">Edit Links</paper-button>
                              <paper-button on-click="editTextMode">Edit Text</paper-button>
                              <paper-button on-click="recordEdits">Save</paper-button>
                              <paper-button on-click="closeEditor">Close</paper-button>
                          </div>
                      </div>
    
                      <div class="card-content" id="editorarea">
                        <div id="display"></div>
                        <paper-textarea id="textarea" label="Edit the text" hidden$="{{hideTextEditor}}"></paper-textarea>
                        <paper-button class="custom green" hidden$="{{hideTextEditor}}">OK</paper-button>
                        <paper-button class="custom red" hidden$="{{hideTextEditor}}">Cancel</paper-button>
                      </div>
                      

                  </paper-card>
                  
                  <!--
                    This <paper-card> is a small box that pops up whenever a user clicks on a link to edit.
                    It contains a header with the href of the link, a <paper-input> to change the label
                    and a 'Save' button to save the label.
                  -->
                  <paper-card id="link-editor" hidden$="{{hideLinkEditor}}">
                    <div class="card-content">
                      <h4>
                        <a id="header"></a>
                      </h4>
                      <paper-input id="input" label="Edit the label"></paper-input>
                      <paper-button class="custom green" on-click="saveLinkLabel">OK</paper-button>
                      <paper-button class="custom red">Cancel</paper-button>
                    </div>
                  </paper-card>
    
                  <!--
                    This <div> will be used to hold the box where the text of the narrative
                    can be directly edited on clicking 'Edit Text' button.
                  -->
                  <!-- <div id="text-editor" hidden$="{{hideTextEditor}}">
                    <!-- <div class="card-content"> -->
                      <!-- <paper-textarea id="text-area" label="Edit the text">
                      </paper-textarea>
                      <paper-button on-click="saveEditedText"></paper-button> -->
                    <!-- </div> -->
                  <!-- </div> -->
                
              </div>
            </resizable-panels>
    
        </app-header-layout>
       
      </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class FeedbackApp extends Polymer.Element {
      static get is() { return 'feedback-app'; }
      static get properties(){
        return {
          /*
          The 'hideEditor' property is used to hide or reveal the <div> containing narrative editor
          */
          hideEditor: {
            type: Boolean,
            value: true
          },
          /*
          The 'hideLinkEditor' property is used to hide or reveal the <paper-card> containing the editor for links
          */
          hideLinkEditor: {
            type: Boolean,
            value: true
          },
          /*
          The 'hideTextEditor' property will be used to hide or reveal the <paper-card> containing the editor for links.
          */
          hideTextEditor: {
            type: Boolean,
            value: true
          },
          /*
          The narrative property is used to bind the contents of the <paper-card> iteratively to elements of an Array
          property (narratives) by dom-repeat. An element in narratives represents the JSON data correspondong to 
          narrative of a single view.
          */
          narratives: {
            type: Array,
            value: []
          },
          /*
          The property narrativeToEdit is one of two state variables - it keeps a record of which narrative view is being
          edited currently and by consequence which edited view will be recorded. 
          */
          narrativeToEdit: {
            type: Number,
            value: -1
          },
          /*
          The editStateDictionary property exists mainly to assist programmers and debuggers to keep a handy reference for the 
          state of the system.
          */
          editStateDictionary: {
            value: {
              0: "editor closed",
              1: "editor opened",
              2: "edit links",
              3: "edit link label",
              4: "edit text",
              5: "record edits"
            }
          },
          /*
          The editState property is the other state variable which keeps track of the current state of the editing process.
          The event handling has been restructured to be similar to the observer pattern. The event handlers relevant to
          editing change a single property - editState, on changing which an observer method - editStateChange is notifed.
          This method is passed both the old value and new value of the observed property as arguments. It can examine these 
          values to take the appropriate action.
          The values taken by editState can be used as a key in editStateDictionary to get a human understandale string 
          description of the state.
          Its default value on loading the page is 0 - corresponding to 'editor closed' state.
          */
          editState: {
            type: Number,
            value: 0,
            observer: "editStateChange"
          },
          /*
          The linkToEdit property encapsulates information about the particular link that is being edited - its link label.
          It has three subproperties - the href attribute of the link, the value of the label before editing and the 
          value of the label after editing.
          */
          linkToEdit: {
            value: {
              href: {
                type: String,
                value: ""
              },
              valueBeforeEdit: {
                type: String,
                value: ""
              },
              valueAfterEdit: {
                type: String,
                value: ""
              }
            }
          },
          /*
          The links edited so far are pushed on to the Array - editedLinks
          */
          editedLinks: {
            type: Array,
            value: []
          }
        };
      }
      /*
        Hide all <span> tags with class "see". This is of course applied to the relevant <div>
        by selecting on the 'identity' attribute of the 'See More' button which triggered this event. 
      */
      seeLess(e){
        var identity = e.target.getAttribute("identity");
        var div = Polymer.dom(this.root).querySelector(".card-content[identity='"+identity+"']");
        $(div).find(".see").hide();
      }
      /*
        Show all <span> tags with class "see"
      */
      seeMore(e){
        var identity = e.target.getAttribute("identity");
        var div = Polymer.dom(this.root).querySelector(".card-content[identity='"+identity+"']");
        $(div).find(".see").show();
      }
      /*
        Toggle the card to expand or collapse
      */
      toggleCollapse(e) {
        var identity = e.target.getAttribute("identity");
        var div = Polymer.dom(this.root).querySelector(".card-content[identity='"+identity+"']");
        $(div).html(this.narratives[identity].text);
        Polymer.dom(this.root).querySelector("iron-collapse[identity='"+identity+"']").toggle();
      }
      /*
        Has the effect of opening the <div> containing the narrative editor and populate it with the 
        contents of the view that caused the editor to open.
        As a matter of implementation, it sets the narrativeToEdit property with the 'identity'
        attribute of the 'Edit' button which caused the editor to open. Additionally, it sets the 
        editState property to 1 - corresponding to the 'editor opened' state. The observer on editState
        which is editStateChange makes the changes.
      */ 
      openEditor(e){
        var identity = e.target.getAttribute("identity");
        this.narrativeToEdit = identity;
        this.editState = 1;
      }
      /*
        Close the editor by setting editState to 0.
      */
      closeEditor(){
        this.editState = 0;
      }
      /*
        Enter into 'edit links' state by setting editState to 2.
      */
      editLinkMode() {
        this.editState = 2;
      }
      /*
        Enter into 'edit text' state by setting editState to 4.
      */
      editTextMode() {
        this.editState = 4;
      }
      /*
        Clicking on the 'Save' button after editing a link label will transition
        to the 'edit links' state by setting editState to 2.
      */
      saveLinkLabel(e) {
        this.editState = 2;
      }
      /*
        Clicking on the 'Save' button after editing the text should transition to
        the 'editor opened' state by setting editState to 1.
      */
      saveEditedText(e){
        this.editState = 1;
      }
      /*
        Clicking on the 'Record Edits' button after making several changes and 'Save's
        should transition to the 'record edits' state by setting editState to 5.
      */
      recordEdits() {
        this.editState = 5;
      }
      /*
        This event handling method called editLinkHandler method is to be associated with
        all the <a> elements in the text of the narrative when the state is 'edit links'.
        Thus, this handler is imperatively added while tranisitioning into 'edit links'
        and removed while transitioning out.
      */
      editLinkHandler(e){
        console.log("In the editLinkHandler method");
        var _self = document.querySelector("feedback-app");
        _self.linkToEdit.href = e.target.href;
        _self.linkToEdit.valueBeforeEdit = e.target.innerHTML;
        Polymer.dom(_self.root).querySelector("#header").innerHTML = _self.linkToEdit.href;
        Polymer.dom(_self.root).querySelector("#header").href = _self.linkToEdit.href;
        Polymer.dom(_self.root).querySelector("#input").value = _self.linkToEdit.valueBeforeEdit;
        _self.editState = 3;
        return false;
      }
      /*
        The 'supermethod' which is the observer on editState property. It includes all the code
        for styling changes and the actual manipulation of DOM and data model.
        It implicitly receives the old and new values of the observed property. Based on these values,
        appropriate action is taken.
      */
      editStateChange(newValue, oldValue){
        // Logging to console for debugging purposes
        console.log(newValue+" : "+this.editStateDictionary[newValue]);
        if(oldValue == 4){
          this.hideTextEditor = true;
        }

        // editState = 0 or 'editor closed' state. 
        // Clear the contents of the editor and make it hidden
        if(newValue == 0){
          Polymer.dom(this.root).querySelector("#editorarea #display").innerHTML = "";
          Polymer.dom(this.root).querySelector("#editor #textarea").innerHTML = "";
          this.narrativeToEdit = -1;
          Polymer.dom(this.root).querySelector("#view").style.width = "";
          Polymer.dom(this.root).querySelector("#editor").style.width = "";
          this.hideEditor = true;
        }

        // editState = 1 or 'editor opened' state.
        // Open the editor panel and populate it with the contents of the card which caused
        // editor to open
        else if(newValue == 1){
          this.hideEditor = false;
          Polymer.dom(this.root).querySelector("#editor").style.width = "50%";
          Polymer.dom(this.root).querySelector("#view").style.width = "50%";
          Polymer.dom(this.root).querySelector("#editorarea #display").innerHTML = Polymer.dom(this.root).querySelector(".card-content[identity='"+this.narrativeToEdit+"']").innerHTML; 
        }
        
        // editState = 2 or 'edit links' satate.
        // There are two changes - change the styling of <a> elements in the editor and
        // associate the handler editLinkHandler with the click event on these <a> elements.
        else if(newValue == 2){
          // If coming from 'edit link label' state, save the link label, if edited
          // by pushing it on to the Array editedLinks
          if(oldValue == 3){
            var inputTextElement = Polymer.dom(this.root).querySelector("#input");
            var linkElement = Polymer.dom(this.root).querySelector("#editorarea #display a[href='"+this.linkToEdit.href+"']");
            var valueAfterSave = inputTextElement.value;
            if(valueAfterSave != this.linkToEdit.valueBeforeEdit){
              this.linkToEdit.valueAfterEdit = valueAfterSave;
              linkElement.innerHTML = this.linkToEdit.valueAfterEdit;
              this.editedLinks.push(JSON.parse(JSON.stringify(this.linkToEdit)));
            }
            console.log(this.editedLinks);
            this.hideLinkEditor = true;
          }
          
          var editorArea = Polymer.dom(this.root).querySelector("#editorarea #display");
          $(editorArea).find("a").css("color", "red");
          $(editorArea).find("a").css("text-decoration", "none");
          $(editorArea).find("a").on("click", this.editLinkHandler);
        }

        // editState = 3 or 'edit llnk label' state.
        // Just un-hide the link-editor <paper-card> 
        else if(newValue == 3){
          this.hideLinkEditor = false;
        }

        // editState = 4 or 'edit text' state.
        // Need to manipulate <paper-textarea> to fill it with HTML corresponding to the text of the view
        else if(newValue == 4){
          var editorArea = Polymer.dom(this.root).querySelector("#editorarea #display");
          $(editorArea).find("a").css("color", "");
          $(editorArea).find("a").css("text-decoration", "");
          $(editorArea).find("a").off("click");
          this.hideLinkEditor = true;
          // var editorArea = Polymer.dom(this.root).querySelector("#editorarea #narrative-dis");
          // console.log(editorArea.innerHTML);
          var textEditor = Polymer.dom(this.root).querySelector("#editorarea #textarea");
          // var editorArea = Polymer.dom(this.root).querySelector("#editorarea");
          // var textArea = Polymer.dom(this.root).querySelector("#text-area");
          // console.log(textEditor);
          // console.log(editorArea);
          // console.log(textArea);
          // var textEditor = this.$.text-area;
          // console.log(textEditor);
          
          // console.log(narrativeDisplay.innerHTML);
          textEditor.value = editorArea.innerHTML;
          this.hideTextEditor = false;
          
        }

        // editState = 5 or 'record edits' state.
        // Currently, prints the Array editedLinks to the console.
        else if(newValue == 5){
          
          // alert(this.editedLinks);
        }
      }
      
      /*
        ready event. It makes an ajax call to retrieve narratives from a JSON file
        Then it manipulates the shadow DOM to insert the data
      */
      ready(){
        super.ready();
        var _self = this;
        $.get("/src/feedback-app/data_narratives.json", function(data){
          _self.narratives = data;
        });
      }
    }
    /*
      Most crucially, establish a binding between the name of the web component
      'feedback-app', which is returned by FeedbackApp.is and the class FeedbackApp
      This is called registration
    */
    window.customElements.define(FeedbackApp.is, FeedbackApp);
  </script>
</dom-module>
